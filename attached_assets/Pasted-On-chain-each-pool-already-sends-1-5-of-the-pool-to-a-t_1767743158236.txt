On-chain, each pool already sends 1.5% of the pool to a treasury wallet via a treasury fee (e.g. treasury_fee_bps = 150).

I now want to implement a referral rewards system, entirely off-chain, that uses this 1.5% treasury share to reward inviters.

No changes to the on-chain program logic – only backend + frontend + DB.

Goal:
Implement a full referral system such that:

Every connected wallet can get a personal referral link.

When a new user arrives through that link and starts using the app, they are permanently linked as "invited by" that referrer (one-time assignment).

For every lottery pool, 1.5% of the pool is split among all referrers who have at least one invited participant in that pool.

The split is equal per referrer present in that pool, not per invited participant.

Example:

Pool total = 1000 tokens, referral share = 1.5% = 15 tokens.

Participant A invited by Referrer R1

Participant B invited by Referrer R2

Participants C, D joined without being invited

Then R1 gets 7.5 tokens, R2 gets 7.5 tokens.

If only one referrer has invited participants in that pool, that referrer gets the full 1.5% share for that pool.

Participants who joined without a referrer still contribute to the pool and to the 1.5% treasury share, but no one is “linked” to them.

Referral rewards are tracked off-chain per referrer & per SPL token mint.

Referrers can later claim their accumulated rewards from a "Referral Rewards" section in the app.

1. Referral Identity Model

Requirements:

Identity is wallet-based: wallet_public_key is the primary key.

Each wallet can optionally have a referrer (another wallet) – set once, then immutable.

A wallet cannot refer itself and no cyclical referral chains.

Referral is optional: users can use the app without any referrer.

Once a wallet has a referrer, all its future pool participations will generate referral rewards for that referrer.

Implement:

A referral registration mechanism:

Referral links like:
https://my-app.com/?ref=<referrer_wallet>
or
https://my-app.com/r/<referrer_code>

When a new user connects their wallet for the first time and a ref parameter is present:

If the user has no referrer yet → link them to that referrer wallet.

If they already have a referrer → ignore the new ref (first referrer wins).

Logic must be resistant to abuse:

No self-referral (wallet cannot set itself as referrer).

No changes after first assignment.

Database (example tables):

referral_links (optional, if you want codes separate from wallets)

referral_relations:

referred_wallet (PK)

referrer_wallet

created_at

source (e.g. link, manual, future extensions)

2. Referral Reward Accounting

Business rules:

The referral reward pool for each lottery pool is 1.5% of the pool total (in tokens), which is already being sent on-chain to the treasury wallet via treasury_fee_bps.

After a pool finishes (winner selected and payout executed), the backend already knows:

pool id

token mint

total pool amount

list of participants (wallets)

Using the participants list and the referral_relations, we want to:

collect all distinct referrers who have at least one invited participant in that pool

let R = number of distinct referrers for that pool

compute referral_pool_amount = total_pool_amount * 0.015 (or from the actual treasury fee bps used for referral)

if R > 0, split referral_pool_amount equally: each referrer gets referral_pool_amount / R

if R == 0, the 1.5% stays in treasury (no off-chain credit assigned).

Implementation requirements:

Create a referral_rewards table to track balances:

id

referrer_wallet

mint (SPL token mint address)

amount_pending (total unclaimed rewards for this mint)

amount_claimed (for history)

last_updated

After each pool resolves (payout done), the backend:

determines the set of referrers present in that pool

computes each referrer’s share for that pool

increments their amount_pending for the corresponding mint

logs an entry in a referral_reward_events table for audit:

id

pool_id

mint

referrer_wallet

amount

created_at

This logic should be integrated in the existing pool resolution flow on the backend (most likely inside or right after the payout / payoutWinner handling or pool-monitor lifecycle).

3. Claiming Referral Rewards

Requirements:

A referrer should be able to go to a "Referral Rewards" section in the dApp and:

see a list of tokens (mints) where they have rewards

see how much is pending / claimable for each mint

click "Claim" to receive those tokens to their wallet.

Rewards are paid from the treasury wallet on-chain (which already receives the 1.5% fee).

Claim is per mint (token type) – they may have rewards in multiple mints if pools use different tokens.

Implementation:

Backend exposes:

GET /api/referrals/summary – returns current user’s referral stats (requires wallet-auth)

GET /api/referrals/rewards – list of rewards per mint:

mint

tokenSymbol (if available)

amount_pending

amount_claimed

POST /api/referrals/claim – body: { mint }

verifies wallet identity via signature/auth system already in place (reuse the nonce + signed message system if it exists)

checks amount_pending > 0

constructs and sends an SPL token transfer transaction from the treasury wallet to the user’s associated token account for that mint

updates DB:

decrease amount_pending

increase amount_claimed

log a claim event (referral_claims table)

Ensure:

proper ATA checks for the user’s token account

creation of ATA if needed (or fail with a clear error if you prefer)

idempotent claim handling (avoid double-claims on race conditions)

Database additions:

referral_claims:

id

referrer_wallet

mint

amount

tx_signature (optional, for tracking on-chain)

claimed_at

4. Frontend: Referral Flow & UI

Requirements:

Add a "Referral Rewards" section/page in the app.

When a wallet is connected:

display the user’s personal referral link (generated from their wallet address)

show stats:

total invited users

total rewards earned

total claimed

list of rewards per token:

token symbol / logo

claimable amount

“Claim” button

When a user arrives via referral link:

frontend should capture the ref parameter (e.g. ?ref=<wallet>)

store it locally (e.g. localStorage) until wallet connects

after wallet connect:

call backend to register the referrer if:

the wallet has no existing referrer

the ref wallet is not the same as the current user

The UI should be consistent with the existing cosmic / terminal theme (dark, neon, space vibe).

Implementation details:

Add a "Referral" button / navigation entry (e.g. in sidebar or header menu).

On the Referral page:

show the full referral URL + "Copy" button

show table of rewards:

Each row = one SPL mint with rewards

Claim button calls POST /api/referrals/claim

On success → show toast + refresh data

On pool pages:

no need to show referral details per pool for now (optional).

logic is handled in backend automatically after pool resolution.

5. Security & Abuse Prevention

Do NOT allow:

self-referral

changing referrer once set

Ensure that:

a referred wallet only has exactly one referrer record in referral_relations

repeated visits with different ref params do not override the original referrer

Use the existing wallet auth mechanism (nonce + signed message) to:

link referral on first connect

fetch referral data

perform claims

6. Output Expectations

Please:

Propose or adapt a minimal DB schema (referral_relations, referral_rewards, referral_reward_events, referral_claims).

Implement or sketch the backend logic in TypeScript/Node (Express) integrated into the existing pool resolution / monitor flow.

Implement the REST API endpoints described above.

Implement or outline the frontend components / hooks for:

capturing ref from URL

registering referrer after wallet connect

Referral Rewards page (React)

Claim flow

Make sure the solution is:

consistent with the existing project structure

multi-token (per mint)

robust for future scaling.

Do NOT modify the on-chain Anchor program – work purely off-chain, using the existing treasury_fee mechanism and treasury wallet as the source of tokens for referral claims.